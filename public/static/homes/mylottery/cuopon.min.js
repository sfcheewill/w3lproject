ec.pkg("ec.member.cuopon");ec.load("jquery.movebar");ec.load("ajax",{loadType:"lazy"});ec.member.cuopon.catelogType=1;ec.ready(function(){$("#my-change-box").show();$("#li-coupon").addClass("current");$("#pathTitle").html("\u6211\u7684\u4f18\u60e0\u5238");$("#ec-tab").navMove({boxClass:"ec-tab-arrow"});ec.member.cuopon.fold()});ec.member.cuopon.load=function(a){new ec.ajax().submit({url:"/member/coupon.json",data:{type:ec.member.cuopon.catelogType,pageNumber:a.pageNumber,pageSize:30},timeout:10000,timeoutFunction:function(){alert("\u8bfb\u53d6\u8d85\u65f6\uff0c\u8bf7\u91cd\u8bd5\uff01")},beforeSendFunction:function(){ec.ui.loading.show({modal:false})},afterSendFunction:ec.ui.loading.hide,successFunction:function(e){if(!e.success){ec.showError(e);return}var g,d;var f="";if(ec.member.cuopon.catelogType!=1){f=" disabled"}if(e.couponList&&e.couponList.length>0){var b=[];b.push('<table cellpadding="0" cellspacing="" class="my-cuopon-list">');b.push('<colgroup><col width="485"><col></colgroup><tbody>');for(var c=0;c<e.couponList.length;c++){var g=e.couponList[c];if(c%2==0){b.push("<tr>")}if(g.deliveryFree==0&&g.ruleType==1){b.push("<td>");b.push('<div class="my-cuopon-detail'+f+'">')}else{b.push("<td>");if(g.deliveryFree==0&&g.ruleType==2){b.push('<div class="my-cuopon-detail my-cuopon-discount'+f+'">')}else{b.push('<div class="my-cuopon-detail my-cuopon-type'+f+'">')}}b.push('<div class="my-cuopon-main clearfix">');b.push('<div class="my-cuopon-info">');if(g.deliveryFree==0&&g.ruleType==1){b.push("<em>&yen;</em>");var d=(g.amount)?parseFloat(g.amount).toFixed(2):"0.00";if(parseInt(d)==d){b.push("<span>"+parseInt(d)+"</span>")}else{b.push("<span>"+d+"</span>")}}else{if(g.deliveryFree==0&&g.ruleType==2){b.push("<span>"+(g.discount*10)+"</span>");b.push("<b>\u6298</b>")}else{b.push("<span>\u514d\u90ae\u5238</span>")}}b.push("</div>");b.push('<div class="my-cuopon-word">');b.push('<p title="'+g.couponName+'">'+g.couponName+"</p>");b.push("<p>"+g.beginDate.parseDate("yyyy-MM-dd").format("yyyy.MM.dd")+"~"+g.endDate.parseDate("yyyy-MM-dd").format("yyyy.MM.dd")+"</p>");b.push('<p title="'+(g.couponCode||"--")+'">\u7f16\u53f7\uff1a'+(g.couponCode||"--")+"</p>");b.push("</div>");if(ec.member.cuopon.catelogType==1){b.push('<a href="/product/coupon/queryPrdForCoupon-'+g.couponCode+'" target="_blank" class="my-cuopon-btn">\u53bb\u4f7f\u7528</a>')}b.push("</div>");b.push('<p class="my-cuopon-explain">');b.push("\u4f7f\u7528\u8981\u6c42\uff1a"+ec.util.escapeHtml(g.couponDes));b.push('<a href="javascript:;" class="btn-cuopon"></a></p>');b.push("</div>");b.push("</td>");if(c%2==1){b.push("</tr>")}}b.push("</tbody>");b.push("</table>");$("#list-group").html(b.join(""));ec.member.cuopon.fold()}else{$("#list-group").html('<div class="list-group"><div class="list-group-empty">\u60a8\u6682\u65f6\u6ca1\u6709\u76f8\u5173\u8bb0\u5f55\u3002</div></div>')}ec.ui.scrollTo("#list-group")}})};ec.member.cuopon.catelog=function(c,a){$(c).parent().addClass("current").siblings().removeClass("current");if(a==1){$("#my-change-box").show()}else{$("#my-change-box").hide()}ec.member.cuopon.catelogType=a;var b={pageNumber:1,pageSize:30};ec.member.cuopon.load(b)};ec.member.cuopon.click=function(){var a={pageNumber:1,pageSize:30};ec.member.cuopon.load(a)};ec.member.cuopon.fold=function(){$(".my-cuopon-explain").each(function(){if($(this).height()>35){$(this).addClass("my-cuopon-explain-more");$(this).children("a").removeClass("hide");$(this).bind("click",function(){if($(this).attr("class").indexOf("my-cuopon-explain-open")==-1){$(this).addClass("my-cuopon-explain-open")}else{$(this).removeClass("my-cuopon-explain-open")}})}})};ec.member.cuopon.renderPage=function(a){if(a.totalPage<=1){$("#list-pager").hide();return}else{$("#list-pager").show()}$("#list-pager").pager({pageNumber:a.pageNumber,pageCount:a.totalPage,recordCount:a.recordCount,pageSize:10,text:{first:"|&lt;",pre:"&lt",next:"&gt;",last:"&gt;|"},item:["first","pre","qpage","next","last","quickPager"],callBack:ec.member.cuopon.load})};ec.member.cuopon.check=function(){var a=($("#my-change-code").val()).trim();if(a.length==0){return}if(a.length<16||a.length>32){ec.member.cuopon.showErrorMsg("\u5238\u7801\u9519\u8bef\uff0c\u8bf7\u91cd\u65b0\u8f93\u5165");return}$.ajax({url:openApiDomain+"/ams/coupon/exchangeCoupon?t="+new Date().getTime(),type:"POST",data:JSON.stringify({busiCode:a}),dataType:"json",timeout:10000,beforeSend:function(b){b.withCredentials=true;b.setRequestHeader("CsrfToken",csrftoken)},error:function(d,c,b){ec.member.cuopon.showErrorMsg("\u4eb2\uff0c\u5151\u6362\u5931\u8d25\u4e86\uff0c\u8bf7\u7a0d\u540e\u518d\u8bd5")},success:function(b){if(b!=""&&b!=undefined){if(b.success){ec.member.cuopon.showSuccessMsg(b)}else{if(b.code=="9206"){ec.account.loginName="";ec.account.afterLogin(function(){ec.member.cuopon.showSuccessMsg(b)})}else{ec.member.cuopon.showErrorMsg(b.errorTip)}}}else{ec.member.cuopon.showErrorMsg("\u4eb2\uff0c\u5151\u6362\u5931\u8d25\u4e86\uff0c\u8bf7\u7a0d\u540e\u518d\u8bd5")}}})};ec.member.cuopon.showErrorMsg=function(d){var a=[];a.push('<div id="pro-add-success-mask" style="visibility:hidden;font-size:18px;width:348px;position: absolute;"></div>');var c=ec.member.cuopon.compute($("#pro-add-success-mask"),d);if(c.h>27){a.push('<div class="box-errors-2">')}else{a.push('<div class="box-errors-1">')}a.push("<span>"+d+"</span>");a.push("</div>");a.push('<div class="box-button"><a href="javascript:;" class="box-ok"><span>\u6211\u77e5\u9053\u4e86</span></a></div>');var b=new ec.box(a.join(""),{boxid:"box_reply_error_msg",boxclass:"ol_box_4 small",title:"",showButton:false,onopen:function(e){e.setPosition()},onok:function(e){ec.member.cuopon.click();e.close()},onclose:function(){}}).open()};ec.member.cuopon.showSuccessMsg=function(e){var c=[];c.push('<div class="box-prompt01-success">');c.push('<div class="h"><i></i></div>');c.push('<div class="b"><p class="title">\u6210\u529f\u5151\u6362'+e.listExchangeCoupon.length+"\u5f20\u4f18\u60e0\u5238</p><p>");for(var b=0;b<e.listExchangeCoupon.length;b++){var a=e.listExchangeCoupon[b];if(b<e.listExchangeCoupon.length-1){c.push("<span>"+a+",</span>")}else{c.push("<span>"+a+"</span>")}}c.push("</p></div></div>");c.push('<div class="box-button">');c.push('<a href="javascript:;" class="box-ok"><span>\u6211\u77e5\u9053\u4e86</span></a>');c.push("</div>");var d=new ec.box(c.join(""),{boxid:"reply-isaccout-box",boxclass:"ol_box_4",showButton:false,onok:function(f){ec.member.cuopon.click();f.close()},onclose:function(){}}).open()};ec.member.cuopon.compute=function(b,a){b.text(a);return{w:b[0].offsetWidth,h:b[0].offsetHeight}};ec.member.cuopon.inputchange=function(){if($("#my-change-code").val().length>0){$("#my-change-buttom").removeClass("disabled")}else{$("#my-change-buttom").addClass("disabled")}};
